---
title: 视频导入性能问题的优化建议和原因
date: 2021-06-22 00:50:40
tags:
---

#### 建议 1

在搜索视频资源时加上 `x264` 或 `264` 关键字。

一般使用 `x264` 编码的视频会在文件名称上标注出来，建议您下载资源时留意下视频文件名是否包含 `x264` 字样。

#### 原因

Comma 使用 FFmpeg 对视频进行剪辑，使用 HTML5 的 Video 标签进行播放。FFmpeg 处理流程大致为: 解封装 --> 解码 --> 编码 --> 封装。由于 Video 标签支持 `H.264` 编码的 MP4 格式视频，Comma 在编码时使用的就是 `H.264`。 `x264`是符合`H.264`标准的开源免费且优秀的编码器（我下载到的资源大都也是采样这种编码），如果源视频编码也是 `x264`，那 Comma 在处理时就几乎就省去了编码的时间。

#### 建议 2

电脑空闲时再开启导入任务。

#### 原因

在视频导入时， Comma 同一时间运行了两个剪辑任务，这可能会导致您的 CPU 资源被 Comma 耗尽，所以建议您在电脑空闲时再开启导入任务。

另外， Comma 没有启用硬件加速。我在开发时曾测试过 FFmpeg 在 Mac 上的硬件加速，速度确实提升不少，但产出的视频简直惨不忍睹，各种调试之后改善不大，最终干脆放弃。加上不同操作系统硬件加速配置可能有所变化，出于兼容性考虑，Comma 目前仅使用软编码。

只提供单一的软编码有利有弊，好处是输出质量好，且用户无需操心该如何配置，有利于保持软件功能简洁，坏处是耗时较长，CPU 占用率高。

不过，最主要原因是我对 FFmpeg 还了解太浅。随着深入学习 FFmpeg，希望晚些时候我能发现优化空间。

#### 建议 3

先集中导入一批资源后再开始学习。

#### 原因

在设计 Comma 时，我曾考虑过不使用剪辑，而是直接保存整个原视频，这样自然省却了剪辑的时间。

但是，当导入视频数量增加到一定程度时，单个视频带来的词汇量就不明显了。这个时候如果还保留整个原视频，无疑是增加了存储负担。

Comma 最多会为每个单词单独剪 200 个剪辑。如果一个片段包含的单词，全部都已经出现过 200 次以上了，Comma 就会直接跳过这个片段。所以，当常见的词汇都已经剪辑到 200 次以后，视频的整体导入速度就会得到提升。

这里提出两个优化思路，后续会择其一改进：

- 对于常见的词汇，不单独剪辑，当它们作为附带词汇出现在其他片段中时予以记录即可。

- 最初导入的特定数量的视频不剪辑，而是完整存储。
